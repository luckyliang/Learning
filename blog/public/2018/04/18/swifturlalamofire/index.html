<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Cheng Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://lruoheng.com/img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="http://lruoheng.com/img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="Siwft网络请求 - Alamofire" />
    <meta property="og:title" content="Siwft网络请求 - Alamofire" />
    <meta property="twitter:title" content="Siwft网络请求 - Alamofire" />
    

    
    <meta name="description" content="Swift 中Alamofire网络请求简单封装">
    <meta property="og:description" content="Swift 中Alamofire网络请求简单封装" />
    <meta property="twitter:description" content="Swift 中Alamofire网络请求简单封装" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="cheng, ChengCheng, chengcheng , Cheng的网络日志, Cheng的博客, chengcheng Blog, 博客, 个人网站, 互联网, Web, 云原生, IOS, Go, Swift, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Siwft网络请求 - Alamofire-Cheng Cheng 的博客 | Cheng Cheng Blog</title>

    <link rel="canonical" href="/2018/04/18/swiftURlAlamofire/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Cheng Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/go">go</a>
                        </li>
                        
                        <li>
                            <a href="/categories/ios">ios</a>
                        </li>
                        
                        <li>
                            <a href="/categories/java">java</a>
                        </li>
                        
                        <li>
                            <a href="/categories/other">other</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                        <li>
                            <a href="/categories/web">web</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E6%B1%87%E7%BC%96">汇编</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('https://img.zhaohuabing.com/in-post/2018-04-11-service-mesh-vs-api-gateway/background.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/ios" title="IOS">
                            IOS
                        </a>
                        
                        <a class="tag" href="/tags/swift" title="Swift">
                            Swift
                        </a>
                        
                    </div>
                    <h1>Siwft网络请求 - Alamofire</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                Cheng
                             
                            on 
                            Wednesday, April 18, 2018
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <p>一个简单的get请求接口为例，搭建一个比较完整的网络框架，其中包括Session管理，路由和错误处理</p>
<p>这里以获取用户文章列表接口为例</p>
<h4 id="创建模型">创建模型</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6272a4">/// 实用泛行实现通用格式</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">ResponseData</span>&lt;ResultData&gt;: Codable <span style="color:#ff79c6">where</span> ResultData: Codable {
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">code</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">data</span>: ResultData
}

<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">Post</span>: Codable {
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">id</span>: <span style="color:#8be9fd;font-style:italic">Int</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">title</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">body</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">userID</span>: <span style="color:#8be9fd;font-style:italic">Int</span>
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Post</span> {
    <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">CodingKeys</span>: <span style="color:#8be9fd;font-style:italic">String</span>, CodingKey {
        <span style="color:#ff79c6">case</span> id
        <span style="color:#ff79c6">case</span> title
        <span style="color:#ff79c6">case</span> body
        <span style="color:#ff79c6">case</span> userID = <span style="color:#f1fa8c">&#34;userId&#34;</span> <span style="color:#6272a4">//自定义key</span>
    }
}
</code></pre></div><h4 id="创建路由postsapirouter">创建路由<code>PostsApiRouter</code></h4>
<h5 id="常量配置">常量配置</h5>
<p>里面包含<code>baseURL</code>, 参数<code>key</code>, <code>header</code>常用字段定义，或者其他&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>

<span style="color:#6272a4">/// baseURL</span>
<span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">ProductionServer</span> {
    <span style="color:#ff79c6">#if</span> <span style="color:#ff79c6">DEBUG</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">baseURL</span> = <span style="color:#f1fa8c">&#34;http://localhost:3000/&#34;</span>
    <span style="color:#ff79c6">#else</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">baseURL</span> = <span style="color:#f1fa8c">&#34;https://jsonplaceholder.typicode.com/&#34;</span>
    <span style="color:#ff79c6">#endif</span>
}

<span style="color:#6272a4">/// 定义传参key值</span>
<span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">APIParameterKey</span> {
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">password</span> = <span style="color:#f1fa8c">&#34;password&#34;</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">email</span>    = <span style="color:#f1fa8c">&#34;email&#34;</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">userId</span>   = <span style="color:#f1fa8c">&#34;userId&#34;</span>
}

<span style="color:#6272a4">/// httpheader</span>
<span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">HTTPHeaderField</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
    <span style="color:#ff79c6">case</span> authentication = <span style="color:#f1fa8c">&#34;Authorization&#34;</span>
    <span style="color:#ff79c6">case</span> contentType = <span style="color:#f1fa8c">&#34;Content-Type&#34;</span>
    <span style="color:#ff79c6">case</span> acceptType = <span style="color:#f1fa8c">&#34;Accept&#34;</span>
    <span style="color:#ff79c6">case</span> acceptEncoding = <span style="color:#f1fa8c">&#34;Accept-Encoding&#34;</span>
}

<span style="color:#6272a4">/// 传输类型</span>
<span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">ContentType</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
    <span style="color:#ff79c6">case</span> json = <span style="color:#f1fa8c">&#34;application/json&#34;</span>
}

</code></pre></div><h5 id="路由postsapirouter">路由<code>PostsApiRouter</code></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#6272a4">/// 文章类路由</span>
<span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">PostsApiRouter</span>{
    <span style="color:#ff79c6">case</span> getPosts(userId: <span style="color:#8be9fd;font-style:italic">Int</span>)
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">PostsApiRouter</span>: APIConfiguration {
    <span style="color:#6272a4">/// 请求方法</span>
    <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">method</span>: HTTPMethod {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getPosts:
            <span style="color:#ff79c6">return</span> .<span style="color:#ff79c6">get</span>
        }
    }
    
    <span style="color:#6272a4">///请求路径</span>
    <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">path</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getPosts:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;posts&#34;</span>
        }
    }
    
    <span style="color:#6272a4">/// 请求参数</span>
    <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">parameters</span>: Parameters? {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getPosts(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">userId</span>):
            <span style="color:#ff79c6">return</span> [APIParameterKey.userId : userId]
        }
    }
    
    <span style="color:#6272a4">//重写encoding</span>
    <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">encoding</span>: ParameterEncoding {
        <span style="color:#ff79c6">switch</span> method {
        <span style="color:#ff79c6">case</span> .<span style="color:#ff79c6">get</span>:
            <span style="color:#ff79c6">return</span> URLEncoding.<span style="color:#ff79c6">default</span>
        <span style="color:#ff79c6">default</span>:
            <span style="color:#ff79c6">return</span> JSONEncoding.<span style="color:#ff79c6">default</span>
        }
    }
    
    <span style="color:#6272a4">///构建request</span>
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">asURLRequest</span>() <span style="color:#ff79c6">throws</span> -&gt; URLRequest {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = <span style="color:#ff79c6">try</span> ProductionServer.baseURL.asURL()
        
        <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">urlRequest</span> = URLRequest(url: url.appendingPathComponent(path))
        
        <span style="color:#6272a4">//http method</span>
        urlRequest.httpMethod = method.rawValue
        
        <span style="color:#6272a4">// header：</span>
        urlRequest.setValue(ContentType.json.rawValue, forHTTPHeaderField: HTTPHeaderField.acceptType.rawValue)
        urlRequest.setValue(ContentType.json.rawValue, forHTTPHeaderField: HTTPHeaderField.contentType.rawValue)
        
        <span style="color:#ff79c6">do</span> {
            urlRequest = <span style="color:#ff79c6">try</span> encoding.encode(urlRequest, with: parameters)
        } <span style="color:#ff79c6">catch</span>  {
            <span style="color:#ff79c6">throw</span> AFError.parameterEncodingFailed(reason: .jsonEncodingFailed(error: error))
        }

        <span style="color:#ff79c6">return</span> urlRequest
        
    }
}
</code></pre></div><h4 id="创建请求管理类">创建请求管理类</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">RxSwift</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">PromiseKit</span>

<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AFApiProvider</span> {
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">_apiProvider</span> = AFApiProvider(session: {() -&gt; Session <span style="color:#ff79c6">in</span>
        <span style="color:#6272a4">///自定义session</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">sessionConfig</span> = URLSessionConfiguration.<span style="color:#ff79c6">default</span>
        sessionConfig.headers = .<span style="color:#ff79c6">default</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverTrustManager</span> = AFTrustManager() <span style="color:#6272a4">//自定义服务器信任管理器</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">interceptor</span> = AFApiRequestInterceptor() <span style="color:#6272a4">//自定义/拦截器，根据需求自行添加</span>
        
        <span style="color:#ff79c6">return</span> Session(configuration: sessionConfig,
                       interceptor: interceptor,
                       serverTrustManager: serverTrustManager,
                       redirectHandler: <span style="color:#ff79c6">nil</span>, <span style="color:#6272a4">//重定向操作</span>
            cachedResponseHandler: <span style="color:#ff79c6">nil</span>, <span style="color:#6272a4">//缓存</span>
            eventMonitors: []) <span style="color:#6272a4">//事件监听</span>
    }())
    
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">shared</span>() -&gt; AFApiProvider {
        <span style="color:#ff79c6">return</span> _apiProvider
    }
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_disposeBag</span> = DisposeBag()
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">_session</span>: Session
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">init</span>(session: Session = Session.<span style="color:#ff79c6">default</span>) {
        _session = session
    }

}
</code></pre></div><h5 id="自定义requestinterceptor">自定义<code>RequestInterceptor</code></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#6272a4">/// 请求拦截器</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AFApiRequestInterceptor</span>: RequestInterceptor {
    
    <span style="color:#6272a4">/// 定义准备请求闭包，可以回调在这个时候做某些事</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_prepare</span>: ((URLRequest) -&gt; URLRequest)?
    <span style="color:#6272a4">/// 将要发送请求闭包</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_willSend</span>: ((URLRequest) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>)?
    
    <span style="color:#8be9fd;font-style:italic">init</span>(prepare:((URLRequest) -&gt; URLRequest)? = <span style="color:#ff79c6">nil</span>, willSend: ((URLRequest) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>)? = <span style="color:#ff79c6">nil</span>) {
        _prepare = prepare
        _willSend = willSend
    }
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">adapt</span>(<span style="color:#ff79c6">_</span> urlRequest: URLRequest, <span style="color:#ff79c6">for</span> session: Session, completion: @escaping (AFResult&lt;URLRequest&gt;) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>) {
        <span style="color:#6272a4">// 准备请求, 然后对request做一些设置，比如这里设置header</span>
        <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">request</span> = _prepare?(urlRequest) ?? urlRequest
        request.setValue(<span style="color:#f1fa8c">&#34;zh-cn&#34;</span>, forHTTPHeaderField: <span style="color:#f1fa8c">&#34;Accept-Language&#34;</span>)
        request.setValue(<span style="color:#f1fa8c">&#34;gzip, deflate&#34;</span>, forHTTPHeaderField: <span style="color:#f1fa8c">&#34;Accept-Encoding&#34;</span>)
        <span style="color:#6272a4">//设置完成后将要发送</span>
        _willSend?(request)
        completion(.success(request))
    }
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">retry</span>(<span style="color:#ff79c6">_</span> request: Request, <span style="color:#ff79c6">for</span> session: Session, dueTo error: Error, completion: @escaping (RetryResult) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>) {
        completion(.doNotRetry)
    }
}
</code></pre></div><h5 id="servertrustmanager"><code>ServerTrustManager</code></h5>
<p>服务器证书信任管理器<code>ServerTrustManager</code>，这里只是陪着不做验证，如果项目需要验证证书的可以写在这个管理器里</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#6272a4">/// 服务器证书信任管理,这里不做验证，信任所有</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AFTrustManager</span>: ServerTrustManager {
    <span style="color:#8be9fd;font-style:italic">init</span>() {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">allHostsMustBeEvaluated</span> = <span style="color:#ff79c6">false</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">evaluators</span> = [<span style="color:#f1fa8c">&#34;&#34;</span>: DisabledEvaluator()] <span style="color:#6272a4">//不做验证</span>
        <span style="color:#ff79c6">super</span>.<span style="color:#8be9fd;font-style:italic">init</span>(allHostsMustBeEvaluated: allHostsMustBeEvaluated, evaluators: evaluators)
    }

</code></pre></div><h4 id="错误处理对服务器错误和服务器和客户端约定错误进行扩展">错误处理，对服务器错误和服务器和客户端约定错误进行扩展</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>
<span style="color:#6272a4">// 服务器报错</span>
<span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">ServerError</span>: Error {
    <span style="color:#ff79c6">case</span> forbidden              <span style="color:#6272a4">//Status code 403</span>
    <span style="color:#ff79c6">case</span> notFound               <span style="color:#6272a4">//Status code 404</span>
    <span style="color:#ff79c6">case</span> internalServerError    <span style="color:#6272a4">//Status code 500</span>
}

<span style="color:#6272a4">/// 服务器错误处理</span>
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">ServerError</span> {
        
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .forbidden:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;服务器禁止访问&#34;</span>
        <span style="color:#ff79c6">case</span> .notFound:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;未找到页面&#34;</span>
        <span style="color:#ff79c6">case</span> .internalServerError:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;服务器异常&#34;</span>
        }
    }
}

<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>

<span style="color:#6272a4">/// 自定义错误和服务器约定错误</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">ServerApiError</span>: Swift.Error {
        <span style="color:#6272a4">/// 解析Json格式错误</span>
        <span style="color:#ff79c6">case</span> parseJsonError

        <span style="color:#6272a4">/// 解析服务器定义StatusCode格式错误</span>
        <span style="color:#ff79c6">case</span> parseStatusCodeTypeError
        
        <span style="color:#6272a4">/// 服务器自定义错误</span>
        <span style="color:#ff79c6">case</span> serverDefineError(code: <span style="color:#8be9fd;font-style:italic">String</span>, message: <span style="color:#8be9fd;font-style:italic">String</span>)
    
}
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">ServerApiError</span> {
    
    <span style="color:#6272a4">/// 错误描述</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorAPIDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .parseJsonError:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;解析Json格式错误&#34;</span>
        <span style="color:#ff79c6">case</span> .parseStatusCodeTypeError:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;解析服务器定义StatusCode格式错误&#34;</span>
        <span style="color:#ff79c6">case</span> .serverDefineError(<span style="color:#ff79c6">_</span>, <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span>): <span style="color:#6272a4">//返回服务器定义的错误信息</span>
            <span style="color:#ff79c6">return</span> message
        }
    }
}


<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#6272a4">///扩展AFError描述属性</span>
<span style="color:#8be9fd;font-style:italic">extension</span>  <span style="color:#50fa7b">AFError</span> {
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">AFErrorDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .invalidURL(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">urlConvertible</span>):
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;无效的URL，错误url: </span><span style="color:#f1fa8c">\(</span>urlConvertible<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>
        <span style="color:#ff79c6">case</span> .sessionDeinitialized:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;&#34;
</span><span style="color:#f1fa8c">            session无效而没有错误，因此它可能被意外取消了初始化。 \
</span><span style="color:#f1fa8c">            在请求期间，请确保保留对您的session的引用。
</span><span style="color:#f1fa8c">            &#34;&#34;&#34;</span>
        <span style="color:#ff79c6">default</span>:
<span style="color:#6272a4">//            return &#34;剩余的自行定义，其实并没有什么用，Alamofire已经对其错误进行了定义`errorDescription`，不过是英文而已，也还比较好理解&#34;</span>
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>.errorDescription
        }
    }
}

<span style="color:#6272a4">/// 扩展错误描述属性</span>
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Swift</span>.Error {
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">description</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">afError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? AFError {
            <span style="color:#ff79c6">return</span> afError.errorDescription
        }<span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? ServerError {
            <span style="color:#ff79c6">return</span> serverError.errorDescription
        }<span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverApiError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? ServerApiError {
            <span style="color:#ff79c6">return</span> serverApiError.errorAPIDescription
        } <span style="color:#ff79c6">else</span> {
            <span style="color:#ff79c6">return</span> localizedDescription
        }
    }
}
	
</code></pre></div><h4 id="请求封装">请求封装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6272a4">/// 请求管理</span>
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">AFApiProvider</span> {
    <span style="color:#6272a4">/// 返回Promis</span>
    <span style="color:#6272a4">/// - Parameters</span>
    <span style="color:#6272a4">///     - urlConvertible: `URLRequestConvertible`请求</span>
    <span style="color:#6272a4">///     - observerOn：`ImmediateSchedulerType` 监听队列 默认全局对列</span>
    <span style="color:#6272a4">///     - subscribeOn: `ImmediateSchedulerType`回调队列 默认主队列</span>
    <span style="color:#6272a4">/// - return: Promise&lt;T&gt;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">request</span>&lt;T: Codable&gt; (<span style="color:#ff79c6">_</span> urlConvertible: Alamofire.URLRequestConvertible,
                                     observerOn: ImmediateSchedulerType = ConcurrentDispatchQueueScheduler(queue: DispatchQueue.global()),
                                     subscribeOn: ImmediateSchedulerType = MainScheduler.instance) -&gt; Promise&lt;T&gt; {
        <span style="color:#ff79c6">return</span> Promise{ seal <span style="color:#ff79c6">in</span>
            
            observerRequest(urlConvertible)
                .observeOn(observerOn)
                .subscribeOn(subscribeOn)
                .subscribe(onSuccess: { seal.fulfill(<span style="color:#8be9fd;font-style:italic">$0</span>)}) { seal.reject(<span style="color:#8be9fd;font-style:italic">$0</span>)}
                .disposed(by: _disposeBag)
        }
    }
    
    <span style="color:#6272a4">/// 发起请求，使用rxswift做回调，里面进行错误统一处理</span>
    <span style="color:#6272a4">/// - Parameters:</span>
    <span style="color:#6272a4">///     - urlConvertible: `URLRequestConvertible` 构建DataRequest</span>
    <span style="color:#6272a4">/// - return: `Single&lt;T&gt;`，`Single&lt;T&gt;` 携带返回模型或错误</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">observerRequest</span>&lt;T: Codable&gt;(<span style="color:#ff79c6">_</span> urlConvertible: Alamofire.URLRequestConvertible) -&gt; Single&lt;T&gt; {
        
        <span style="color:#ff79c6">return</span> Single&lt;T&gt;.create { (observer) -&gt; Disposable <span style="color:#ff79c6">in</span>
            
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">request</span> =  AFApiProvider.shared()._session
                .request(urlConvertible)
                .validate()
                .responseDecodable { (response: DataResponse&lt;T&gt; ) <span style="color:#ff79c6">in</span>
                    <span style="color:#ff79c6">do</span> {
                        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">dataModel</span> =  <span style="color:#ff79c6">try</span> response
                            ._storeServerTimerIntervalDistance()
                            ._catchRandomDomainFlag()
                            ._filterServerSuccessData()<span style="color:#6272a4">///验证服务器格式和定义的错误</span>
                            .map(type: T.<span style="color:#ff79c6">self</span>)  <span style="color:#6272a4">//json转模型</span>
                        observer(.success(dataModel))
                    } <span style="color:#ff79c6">catch</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span>{
                        observer(.error(error))
                    }
            }
            
            <span style="color:#ff79c6">return</span> Disposables.create {
                
                request.cancel()
            }
        }
    }
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">DataResponse</span> {
    
    <span style="color:#6272a4">/// 校验http返回 校准服务器时间，看自己需求是否需要</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_storeServerTimerIntervalDistance</span>() <span style="color:#ff79c6">throws</span> -&gt; DataResponse {
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverTime</span> = response?.allHeaderFields[<span style="color:#f1fa8c">&#34;Date&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span> <span style="color:#ff79c6">else</span> {
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
        }
        
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">dataFormatter</span> = DateFormatter().then {
            <span style="color:#8be9fd;font-style:italic">$0</span>.locale = Locale(identifier: <span style="color:#f1fa8c">&#34;en_US_POSIX&#34;</span>)
            <span style="color:#8be9fd;font-style:italic">$0</span>.dateFormat = <span style="color:#f1fa8c">&#34;EEE, d MMM yyyy HH:mm:ss zzz&#34;</span>
        }
        
        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverDate</span> = dataFormatter.date(from: serverTime) {
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">timeIntervaDistance</span> = Date().timeIntervalSince1970 <span style="color:#ff79c6">-</span> serverDate.timeIntervalSince1970
            print(<span style="color:#f1fa8c">&#34;请求时间差: </span><span style="color:#f1fa8c">\(</span>timeIntervaDistance<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
            
        }
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
    }
    
    <span style="color:#6272a4">///根据http返回处理特殊逻辑，如切换域名等,看自己需求</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_catchRandomDomainFlag</span>() -&gt; DataResponse {
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">statusCode</span> = response?.statusCode <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span> }
        <span style="color:#ff79c6">if</span> [<span style="color:#bd93f9">403</span>, <span style="color:#bd93f9">502</span>, <span style="color:#bd93f9">503</span>].contains(statusCode) {
            print(<span style="color:#f1fa8c">&#34;http 错误码: </span><span style="color:#f1fa8c">\(</span>statusCode<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
        }
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
    }
    
    <span style="color:#6272a4">/// 服务器返回数据格式错误,这样就必须让服务端按规范的数据格式返回数据，不然直接抛出错误</span>
    <span style="color:#6272a4">/// 根据自己项目需求更改</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_filterServerSuccessData</span>() <span style="color:#ff79c6">throws</span> -&gt; DataResponse {
        
        <span style="color:#ff79c6">do</span> {
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">responseJson</span> = <span style="color:#ff79c6">try</span> mapJSON(failsOnEmptyData: <span style="color:#ff79c6">false</span>)
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">dic</span> = responseJson <span style="color:#ff79c6">as</span>? [<span style="color:#8be9fd;font-style:italic">String</span> : <span style="color:#8be9fd;font-style:italic">Any</span>] <span style="color:#ff79c6">else</span> {
                <span style="color:#ff79c6">throw</span> ServerApiError.parseJsonError
            }
            <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> = _praseServerError(dic: dic) { <span style="color:#ff79c6">throw</span> error  }
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
        } <span style="color:#ff79c6">catch</span>  {
            <span style="color:#ff79c6">throw</span> error
        }
    }
    
    
    <span style="color:#6272a4">/// 服务器自定义数据错误，直接抛出错误</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_praseServerError</span>(dic:[<span style="color:#8be9fd;font-style:italic">String</span>: <span style="color:#8be9fd;font-style:italic">Any</span>]) -&gt; Error? {
        
        <span style="color:#6272a4">//returnCode 为服务器与前端约定的returnCode</span>
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">code</span> = dic[<span style="color:#f1fa8c">&#34;code&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span> <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">return</span> ServerApiError.parseStatusCodeTypeError }
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span> = dic[<span style="color:#f1fa8c">&#34;message&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span>
        <span style="color:#ff79c6">guard</span> [<span style="color:#f1fa8c">&#34;000000&#34;</span>].contains(code) <span style="color:#ff79c6">else</span> { <span style="color:#6272a4">//比如0为请求成功，那么其他状态为错误信息，返回错误</span>
            <span style="color:#ff79c6">return</span> ServerApiError.serverDefineError(code: code, message: message ?? <span style="color:#f1fa8c">&#34;服务器返回 错误 code: </span><span style="color:#f1fa8c">\(</span>code<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
        }
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
    }
    
    
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">DataResponse</span> {
    
    <span style="color:#6272a4">/// 对返回结果转Json</span>
    <span style="color:#6272a4">/// - failsOnEmptyData：默认为true, 如果失败返回空</span>
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">mapJSON</span>(failsOnEmptyData: <span style="color:#8be9fd;font-style:italic">Bool</span> = <span style="color:#ff79c6">true</span>) <span style="color:#ff79c6">throws</span> -&gt; <span style="color:#8be9fd;font-style:italic">Any</span> {
        
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> `data` = data <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">return</span> NSNull() }
        <span style="color:#ff79c6">do</span> {
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">try</span> JSONSerialization.jsonObject(with: data, options: .allowFragments)
        } <span style="color:#ff79c6">catch</span> {
            <span style="color:#ff79c6">if</span> data.count <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>failsOnEmptyData {
                <span style="color:#ff79c6">return</span> NSNull()
            }
            <span style="color:#ff79c6">throw</span> AFError.responseSerializationFailed(reason: .jsonSerializationFailed(error: error))
        }
    }
    
    <span style="color:#6272a4">/// 将json转成模型，参考moya</span>
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">map</span>&lt;D: Decodable&gt;(type: D.<span style="color:#ff79c6">Type</span>, atKeyPath keyPath: <span style="color:#8be9fd;font-style:italic">String</span>? = <span style="color:#ff79c6">nil</span>, using decoder: JSONDecoder = JSONDecoder(), failsOnEmptyData: <span style="color:#8be9fd;font-style:italic">Bool</span> = <span style="color:#ff79c6">true</span>) <span style="color:#ff79c6">throws</span> -&gt; D {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serializeToData</span>: (<span style="color:#8be9fd;font-style:italic">Any</span>) <span style="color:#ff79c6">throws</span> -&gt; Data? = { (jsonObject) <span style="color:#ff79c6">in</span>
            <span style="color:#ff79c6">guard</span> JSONSerialization.isValidJSONObject(jsonObject) <span style="color:#ff79c6">else</span> {
                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
            }
            <span style="color:#ff79c6">do</span> {
                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">try</span> JSONSerialization.data(withJSONObject: jsonObject)
            } <span style="color:#ff79c6">catch</span> {
                <span style="color:#ff79c6">throw</span> AFError.responseSerializationFailed(reason: .jsonSerializationFailed(error: error))
            }
        }
        
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> `data` = data <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">throw</span> APIError.parseJsonError }
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">jsonData</span>: Data
        
        keyPathCheck: <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">keyPath</span> = keyPath {
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">jsonObject</span> = (<span style="color:#ff79c6">try</span> mapJSON(failsOnEmptyData: failsOnEmptyData) <span style="color:#ff79c6">as</span>? NSDictionary)?.value(forKeyPath: keyPath) <span style="color:#ff79c6">else</span> {
                <span style="color:#ff79c6">if</span> failsOnEmptyData {
                    <span style="color:#ff79c6">throw</span> APIError.parseJsonError
                } <span style="color:#ff79c6">else</span> {
                    jsonData = data
                    <span style="color:#ff79c6">break</span> keyPathCheck
                }
            }
            
            <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">data</span> = <span style="color:#ff79c6">try</span> serializeToData(jsonObject) {
                jsonData = data
            } <span style="color:#ff79c6">else</span> {
                <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">wrappedJsonObject</span> = [<span style="color:#f1fa8c">&#34;value&#34;</span>: jsonObject]
                <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">wrappedJsonData</span>: Data
                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">data</span> = <span style="color:#ff79c6">try</span> serializeToData(wrappedJsonObject) {
                    wrappedJsonData = data
                } <span style="color:#ff79c6">else</span> {
                    <span style="color:#ff79c6">throw</span> APIError.parseJsonError
                }
                <span style="color:#ff79c6">do</span> {
                    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">try</span> decoder.decode(DecodableWrapper&lt;D&gt;.<span style="color:#ff79c6">self</span>, from: wrappedJsonData).value
                } <span style="color:#ff79c6">catch</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> {
                    <span style="color:#ff79c6">throw</span> AFError.responseSerializationFailed(reason: .jsonSerializationFailed(error: error))
                }
            }
        } <span style="color:#ff79c6">else</span> {
            jsonData = data
        }
        <span style="color:#ff79c6">do</span> {
            <span style="color:#ff79c6">if</span> jsonData.count <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>failsOnEmptyData {
                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONObjectData</span> = <span style="color:#f1fa8c">&#34;{}&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(D.<span style="color:#ff79c6">self</span>, from: emptyJSONObjectData) {
                    <span style="color:#ff79c6">return</span> emptyDecodableValue
                } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONArrayData</span> = <span style="color:#f1fa8c">&#34;[{}]&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(D.<span style="color:#ff79c6">self</span>, from: emptyJSONArrayData) {
                    <span style="color:#ff79c6">return</span> emptyDecodableValue
                }
            }
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">try</span> decoder.decode(D.<span style="color:#ff79c6">self</span>, from: jsonData)
        } <span style="color:#ff79c6">catch</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> {
            <span style="color:#ff79c6">throw</span> AFError.responseSerializationFailed(reason: .jsonSerializationFailed(error: error))
        }
    }
}

<span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">DecodableWrapper</span>&lt;T: Decodable&gt;: Decodable {
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">value</span>: T
}
</code></pre></div><h4 id="也可提供一个api管理类可有可无方便管理">也可提供一个api管理类，可有可无，方便管理</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">PromiseKit</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">RxSwift</span>

<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">APIClient</span> {
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getPosts</span>(userId: <span style="color:#8be9fd;font-style:italic">Int</span>) -&gt;Promise&lt;ResponseData<span style="color:#ff79c6">&lt;</span>[Post]<span style="color:#ff79c6">&gt;&gt;</span> {
        
        <span style="color:#ff79c6">return</span> AFApiProvider.shared().request(PostsApiRouter.getPosts(userId: userId))
    }
}
</code></pre></div><h4 id="最后完成请求">最后完成请求</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">    <span style="color:#ff79c6">@IBAction</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">requestClick</span>(<span style="color:#ff79c6">_</span> sender: <span style="color:#8be9fd;font-style:italic">Any</span>) {
        
        APIClient.getPosts(userId: <span style="color:#bd93f9">101</span>).ensure {
          <span style="color:#6272a4">///这里可做网络菊花之类的</span>
            print(<span style="color:#f1fa8c">&#34;请求中....&#34;</span>)
        }.done { (postData) <span style="color:#ff79c6">in</span>
            print(<span style="color:#f1fa8c">&#34;请求完成....&#34;</span>)
            postData.data.forEach { (post) <span style="color:#ff79c6">in</span>
                print(post)
            }
        }.<span style="color:#ff79c6">catch</span> { (error) <span style="color:#ff79c6">in</span>
                 <span style="color:#6272a4">///错误处理</span>
            print(error.description)
        }
    }
</code></pre></div>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/04/18/swiftURlSession/" data-toggle="tooltip" data-placement="top" title="Siwft网络请求 - URLSession">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/04/19/swiftURlAlamofireDetail/" data-toggle="tooltip" data-placement="top" title="Alamofire源码解析">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/go" title="go">
                            go
                        </a>
                        
                        
                        
                        <a href="/tags/ios" title="ios">
                            ios
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/swift" title="swift">
                            swift
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/web" title="web">
                            web
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Cheng Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:401932941@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/luckyliang">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Cheng Blog 2017
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
