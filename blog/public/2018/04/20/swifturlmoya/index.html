<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Cheng Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://lruoheng.com/img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="http://lruoheng.com/img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="Swift网络请求 - RXSwift &#43; PromiseKit &#43; Moya" />
    <meta property="og:title" content="Swift网络请求 - RXSwift &#43; PromiseKit &#43; Moya" />
    <meta property="twitter:title" content="Swift网络请求 - RXSwift &#43; PromiseKit &#43; Moya" />
    

    
    <meta name="description" content="Swift 中 Moya三方框架的配置和使用">
    <meta property="og:description" content="Swift 中 Moya三方框架的配置和使用" />
    <meta property="twitter:description" content="Swift 中 Moya三方框架的配置和使用" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="cheng, ChengCheng, chengcheng , Cheng的网络日志, Cheng的博客, chengcheng Blog, 博客, 个人网站, 互联网, Web, 云原生, IOS, Go, Swift, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Swift网络请求 - RXSwift &#43; PromiseKit &#43; Moya-Cheng Cheng 的博客 | Cheng Cheng Blog</title>

    <link rel="canonical" href="/2018/04/20/swiftURlMoya/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Cheng Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/go">go</a>
                        </li>
                        
                        <li>
                            <a href="/categories/ios">ios</a>
                        </li>
                        
                        <li>
                            <a href="/categories/java">java</a>
                        </li>
                        
                        <li>
                            <a href="/categories/other">other</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                        <li>
                            <a href="/categories/web">web</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E6%B1%87%E7%BC%96">汇编</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('https://img.zhaohuabing.com/in-post/2018-04-11-service-mesh-vs-api-gateway/background.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/ios" title="IOS">
                            IOS
                        </a>
                        
                        <a class="tag" href="/tags/swift" title="Swift">
                            Swift
                        </a>
                        
                    </div>
                    <h1>Swift网络请求 - RXSwift &#43; PromiseKit &#43; Moya</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                Cheng
                             
                            on 
                            Friday, April 20, 2018
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <p>Moya是基于<code>Alamofire</code>网络框架上进行的封装，支持RXSwift</p>
<h4 id="创建模型">创建模型</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>

<span style="color:#6272a4">/// 实用泛行实现通用格式</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">ResponseData</span>&lt;T&gt;: Codable <span style="color:#ff79c6">where</span> T: Codable {
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">code</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">data</span>: T?
}


<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">Post</span>: Codable {
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">id</span>: <span style="color:#8be9fd;font-style:italic">Int</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">title</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">body</span>: <span style="color:#8be9fd;font-style:italic">String</span>
    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">userID</span>: <span style="color:#8be9fd;font-style:italic">Int</span>
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Post</span> {
    <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">CodingKeys</span>: <span style="color:#8be9fd;font-style:italic">String</span>, CodingKey {
        <span style="color:#ff79c6">case</span> id
        <span style="color:#ff79c6">case</span> title
        <span style="color:#ff79c6">case</span> body
        <span style="color:#ff79c6">case</span> userID = <span style="color:#f1fa8c">&#34;userId&#34;</span> <span style="color:#6272a4">//自定义key</span>
    }
}
</code></pre></div><h4 id="定义targettype">定义<code>TargetType</code></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>

<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">ServerApi</span> {
    <span style="color:#6272a4">///定义请求接口参数</span>
    <span style="color:#ff79c6">case</span> getNews(channel: <span style="color:#8be9fd;font-style:italic">String</span>, start: <span style="color:#8be9fd;font-style:italic">Int</span>, num: <span style="color:#8be9fd;font-style:italic">Int</span>)
    <span style="color:#ff79c6">case</span> getPosts(id: <span style="color:#8be9fd;font-style:italic">Int</span>)
}

<span style="color:#6272a4">/// 实现协议方法</span>
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">ServerApi</span>: TargetType {
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">baseURL</span>: URL {
        <span style="color:#ff79c6">#if</span> <span style="color:#ff79c6">DEVELOP</span>
        <span style="color:#ff79c6">return</span> URL(string: <span style="color:#f1fa8c">&#34;http://localhost:3000&#34;</span>)<span style="color:#ff79c6">!</span>
        <span style="color:#ff79c6">#elseif</span> <span style="color:#ff79c6">PREVIEW</span>
        <span style="color:#ff79c6">return</span> URL(string: <span style="color:#f1fa8c">&#34;http://localhost:3000&#34;</span>)<span style="color:#ff79c6">!</span>
        <span style="color:#ff79c6">#else</span>
        <span style="color:#ff79c6">return</span> URL(string: <span style="color:#f1fa8c">&#34;http://localhost:3000&#34;</span>)<span style="color:#ff79c6">!</span>
        <span style="color:#ff79c6">#endif</span>
    }
    <span style="color:#6272a4">/// 路径拼接</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">path</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getNews: <span style="color:#6272a4">///获取新闻列表</span>
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;/getNews&#34;</span>
        <span style="color:#ff79c6">case</span> .getPosts:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;/posts&#34;</span>
        }
    }
    <span style="color:#6272a4">///请求方式</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">method</span>: Method {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getNews:
            <span style="color:#ff79c6">return</span> .post
        <span style="color:#ff79c6">case</span> .getPosts:
            <span style="color:#ff79c6">return</span> .<span style="color:#ff79c6">get</span>
        }
    }
    <span style="color:#6272a4">///编码格式</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">sampleData</span>: Data {
        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>.data(using: .utf8)<span style="color:#ff79c6">!</span>
    }
    
    <span style="color:#6272a4">/// 请求任务</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">task</span>: Task {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .getNews(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">channel</span>, <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">start</span>, <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">num</span>):
            
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">param</span>: [<span style="color:#8be9fd;font-style:italic">String</span>: <span style="color:#8be9fd;font-style:italic">Any</span>] = [<span style="color:#f1fa8c">&#34;channel&#34;</span>:channel,<span style="color:#f1fa8c">&#34;start&#34;</span>:start,<span style="color:#f1fa8c">&#34;num&#34;</span>: num]
            <span style="color:#ff79c6">return</span> .requestParameters(parameters: param, encoding: URLEncoding.<span style="color:#ff79c6">default</span>)
            
        <span style="color:#ff79c6">case</span> .getPosts(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">userId</span>):
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">param</span>: [<span style="color:#8be9fd;font-style:italic">String</span>: <span style="color:#8be9fd;font-style:italic">Int</span>] = [<span style="color:#f1fa8c">&#34;userId&#34;</span>:userId]
            <span style="color:#ff79c6">return</span> .requestParameters(parameters: param, encoding: URLEncoding.<span style="color:#ff79c6">default</span>)
            
        }
    }
    
    <span style="color:#6272a4">/// heder 可根据不同的接口设置不通的header</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">headers</span>: [<span style="color:#8be9fd;font-style:italic">String</span> : <span style="color:#8be9fd;font-style:italic">String</span>]? {
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
    }
    
}

</code></pre></div><h4 id="网络请求管理">网络请求管理</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">RxSwift</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">PromiseKit</span>

<span style="color:#6272a4">/// 服务器网络请求</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">APIProvider</span>&lt;Target: TargetType&gt; {
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_disposeBag</span> = DisposeBag()
    <span style="color:#6272a4">///定义网络请求发起着</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_privider</span> = MoyaProvider&lt;Target&gt;(callbackQueue: .global(), session:{() -&gt; Session <span style="color:#ff79c6">in</span>
        
        <span style="color:#6272a4">// 配置特殊网络需求</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverTrustManager</span> = APIServerTrustManager()
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">interceptor</span> = APIRequestInterceptor()
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">configuration</span> = URLSessionConfiguration.<span style="color:#ff79c6">default</span>
        configuration.timeoutIntervalForRequest = <span style="color:#bd93f9">15</span> <span style="color:#6272a4">//设置请求超时时间</span>
        configuration.headers = .<span style="color:#ff79c6">default</span>
        <span style="color:#ff79c6">return</span> Session(configuration: configuration,
                              interceptor: interceptor,
                              serverTrustManager: serverTrustManager,
                              redirectHandler: <span style="color:#ff79c6">nil</span>,
                              cachedResponseHandler: <span style="color:#ff79c6">nil</span>,
                              eventMonitors: [])
        
    }(),  plugins: [NetWorksActivityPlugin(),
                    NetWorksLoggerPlugin()])
    
    <span style="color:#6272a4">/// 网络请求</span>
    <span style="color:#6272a4">///</span>
    <span style="color:#6272a4">/// - Parameters:</span>
    <span style="color:#6272a4">///   - target: API类型</span>
    <span style="color:#6272a4">///   - observeOn: 发起请求的Scheduler</span>
    <span style="color:#6272a4">///   - subscribeOn: 相应请求返回的Scheduler</span>
    <span style="color:#6272a4">///   - retryCount: 发生错误时重试次数</span>
    <span style="color:#6272a4">/// - Returns: 指定范型的Promise</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">request</span>&lt;T: Codable&gt;(targetType: Target,
                                    observeOn: ImmediateSchedulerType = ConcurrentDispatchQueueScheduler(queue: DispatchQueue.global()),
                                    subscribeOn: ImmediateSchedulerType = MainScheduler.instance) -&gt; Promise&lt;T&gt; {
        
        <span style="color:#ff79c6">return</span> Promise { seal <span style="color:#ff79c6">in</span>
            
            _privider.rx
                .request(targetType, callbackQueue: DispatchQueue.global())
                .observeOn(observeOn).map({
                    <span style="color:#ff79c6">try</span> <span style="color:#8be9fd;font-style:italic">$0</span>._storeServerTimeIntervalDistance()
                        ._catchRandomDomainFlag()
                        ._filterServerSuccessData()
                        .map(T.<span style="color:#ff79c6">self</span>) <span style="color:#6272a4">///这里根据自己需要，可直接转成模型，或者使用mapJson,或mapString</span>
                })
                .subscribeOn(subscribeOn)
                .subscribe(onSuccess: {
                    seal.fulfill(<span style="color:#8be9fd;font-style:italic">$0</span>)
                }, onError: { (error) <span style="color:#ff79c6">in</span>
                    seal.reject(error)
                })
                .disposed(by: _disposeBag)
        }
    }
}


<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Response</span> {
    
    <span style="color:#6272a4">/// 根据http返回 校准服务器时间</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_storeServerTimeIntervalDistance</span>() <span style="color:#ff79c6">throws</span> -&gt; Response {
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverTime</span> = response?.allHeaderFields[<span style="color:#f1fa8c">&#34;Date&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span> <span style="color:#ff79c6">else</span> {
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
        }
        
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">dateFormatter</span> = DateFormatter().then {
            <span style="color:#8be9fd;font-style:italic">$0</span>.locale = Locale(identifier: <span style="color:#f1fa8c">&#34;en_US_POSIX&#34;</span>)
            <span style="color:#8be9fd;font-style:italic">$0</span>.dateFormat = <span style="color:#f1fa8c">&#34;EEE, d MMM yyyy HH:mm:ss zzz&#34;</span>
        }
        
        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">serverDate</span> = dateFormatter.date(from: serverTime) { <span style="color:#6272a4">// 此处无需时区处理</span>
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">timeIntervalDistance</span> = Date().timeIntervalSince1970 <span style="color:#ff79c6">-</span> serverDate.timeIntervalSince1970
            print(<span style="color:#f1fa8c">&#34;请求时间差: </span><span style="color:#f1fa8c">\(</span>timeIntervalDistance<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
<span style="color:#6272a4">//            SystemDataManager.shared.preinfoManager.timeIntervalDistance = timeIntervalDistance</span>
        }
        
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
    }
    
    
    <span style="color:#6272a4">/// 根据http返回 处理特殊逻辑 如切换域名</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_catchRandomDomainFlag</span>() -&gt; Response {
        <span style="color:#ff79c6">if</span> [<span style="color:#bd93f9">403</span>, <span style="color:#bd93f9">502</span>, <span style="color:#bd93f9">503</span>].contains(statusCode) { <span style="color:#6272a4">// 有错误可以抛特殊异常 用与retry</span>
            print(<span style="color:#f1fa8c">&#34;http 错误码: </span><span style="color:#f1fa8c">\(</span>statusCode<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
        }
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
    }
    
    <span style="color:#6272a4">/// 服务器返回数据格式错误</span>
    fileprivate <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_filterServerSuccessData</span>() <span style="color:#ff79c6">throws</span> -&gt; Response {
        <span style="color:#ff79c6">do</span> {
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">responseJson</span> = <span style="color:#ff79c6">try</span> mapJSON(failsOnEmptyData: <span style="color:#ff79c6">false</span>)
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">dict</span> = responseJson <span style="color:#ff79c6">as</span>? [<span style="color:#8be9fd;font-style:italic">String</span>: <span style="color:#8be9fd;font-style:italic">Any</span>] <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">throw</span> APIError.parseJsonError }
            <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> = _praseServerError(dict: dict) { <span style="color:#ff79c6">throw</span> error }
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">self</span>
        } <span style="color:#ff79c6">catch</span> {
            <span style="color:#ff79c6">throw</span> error
        }
    }
    
    
    <span style="color:#6272a4">/// 服务器自定义错误</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_praseServerError</span>(dict: [<span style="color:#8be9fd;font-style:italic">String</span>: <span style="color:#8be9fd;font-style:italic">Any</span>]) -&gt; Error? {
        <span style="color:#6272a4">/**
</span><span style="color:#6272a4">         {
</span><span style="color:#6272a4">            code: &#34;000000&#34;
</span><span style="color:#6272a4">            message: &#34;请求成功&#34;
</span><span style="color:#6272a4">            data: {}
</span><span style="color:#6272a4">         }
</span><span style="color:#6272a4">         */</span>
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">code</span> = dict[<span style="color:#f1fa8c">&#34;code&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span> <span style="color:#ff79c6">else</span> { <span style="color:#6272a4">//跟自己服务器约定的返回值字段</span>
            <span style="color:#ff79c6">return</span> APIError.parseStatusCodeTypeError
        }
        
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span> = dict[<span style="color:#f1fa8c">&#34;message&#34;</span>] <span style="color:#ff79c6">as</span>? <span style="color:#8be9fd;font-style:italic">String</span> <span style="color:#6272a4">//跟服务器约定的message字段</span>
        
        <span style="color:#ff79c6">guard</span> [<span style="color:#f1fa8c">&#34;000000&#34;</span>].contains(code) <span style="color:#ff79c6">else</span> { <span style="color:#6272a4">// 有错误,根据与服务器约定code判断</span>
            <span style="color:#ff79c6">return</span> APIError.serverDefineError(code: code,
                                              message: message ?? <span style="color:#f1fa8c">&#34;服务器返回 returnCode：</span><span style="color:#f1fa8c">\(</span>code<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
        }
        
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
    }
    
}

</code></pre></div><h4 id="interceptor"><code>interceptor</code></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#6272a4">/// 对request在发出前进行特殊处理</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">APIRequestInterceptor</span>: RequestInterceptor {
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_prepare</span>: ((URLRequest) -&gt; URLRequest)?
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_willSend</span>: ((URLRequest) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>)?
    
    <span style="color:#8be9fd;font-style:italic">init</span>(prepare: ((URLRequest) -&gt; URLRequest)? = <span style="color:#ff79c6">nil</span>, willSend:((URLRequest) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>)? = <span style="color:#ff79c6">nil</span>) {
        _prepare = prepare
        _willSend = willSend
    }
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">adapt</span>(<span style="color:#ff79c6">_</span> urlRequest: URLRequest, <span style="color:#ff79c6">for</span> session: Session, completion: @escaping (AFResult&lt;URLRequest&gt;) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>) {
        <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">request</span> = _prepare?(urlRequest) ?? urlRequest
        request.setValue(<span style="color:#f1fa8c">&#34;iphoneX&#34;</span>, forHTTPHeaderField: <span style="color:#f1fa8c">&#34;User-Agent&#34;</span>)
        request.setValue(<span style="color:#f1fa8c">&#34;ios&#34;</span>, forHTTPHeaderField: <span style="color:#f1fa8c">&#34;client-type&#34;</span>)
        _willSend?(request)
        completion(.success(request))
    }
}
</code></pre></div><h4 id="服务器信任servertrustmanager">服务器信任<code>ServerTrustManager</code></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Alamofire</span>

<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">APIServerTrustManager</span>: ServerTrustManager {
    <span style="color:#8be9fd;font-style:italic">init</span>() {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">allHostsMustBeEvaluated</span> = <span style="color:#ff79c6">false</span>
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">evaluators</span> = [<span style="color:#f1fa8c">&#34;&#34;</span>: DisabledEvaluator()]
        <span style="color:#ff79c6">super</span>.<span style="color:#8be9fd;font-style:italic">init</span>(allHostsMustBeEvaluated: allHostsMustBeEvaluated, evaluators: evaluators)
    }
}
</code></pre></div><h4 id="插件plugin">插件<code>Plugin</code></h4>
<p>网络知识器管理器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">UIKit</span>

<span style="color:#6272a4">/// 网络活动指示器</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">NetWorksIndicatorScheduler</span> {
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">shared</span> = NetWorksIndicatorScheduler()
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">init</span>(){}
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">_activityCount</span>: <span style="color:#8be9fd;font-style:italic">Int</span> = <span style="color:#bd93f9">0</span>
    
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#ff79c6">lazy</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">_activityQueue</span> = DispatchQueue(label: <span style="color:#f1fa8c">&#34;ActivityIndicatorQueue&#34;</span>)
    
    <span style="color:#6272a4">/// 加载网络活动指示器</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">pushActivityIndicator</span>() {
        _activityQueue.sync { [<span style="color:#ff79c6">weak</span> <span style="color:#ff79c6">self</span>] <span style="color:#ff79c6">in</span>
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">self</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">return</span> }
            <span style="color:#ff79c6">self</span>._activityCount <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
            <span style="color:#ff79c6">self</span>._updateActivityIndicator()
        }
    }
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">popActivityIndicator</span>() {
        _activityQueue.sync { [<span style="color:#ff79c6">weak</span> <span style="color:#ff79c6">self</span>] <span style="color:#ff79c6">in</span>
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">self</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">return</span> }
            <span style="color:#ff79c6">self</span>._activityCount <span style="color:#ff79c6">-=</span> <span style="color:#bd93f9">1</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">self</span>._activityCount <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span> {
                <span style="color:#ff79c6">self</span>._activityCount = <span style="color:#bd93f9">0</span>
            }
            <span style="color:#ff79c6">self</span>._updateActivityIndicator()
        }
    }
    
    <span style="color:#6272a4">/// 更新状态</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">_updateActivityIndicator</span>() {
        DispatchQueue.main.async {
            UIApplication.shared.isNetworkActivityIndicatorVisible = <span style="color:#ff79c6">self</span>._activityCount <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>
        }
    }
    
}
</code></pre></div><p><code>NetWorksActivityPlugin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>

<span style="color:#6272a4">/// 网络活动状态观察</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">NetWorksActivityPlugin</span>: PluginType {
    
    <span style="color:#6272a4">/// 将要发送的时候开启</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">willSend</span>(<span style="color:#ff79c6">_</span> request: RequestType, target: TargetType) {
        NetWorksIndicatorScheduler.shared.pushActivityIndicator()
    }
    
    <span style="color:#6272a4">/// 数据返回关闭</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">didReceive</span>(<span style="color:#ff79c6">_</span> result: Result&lt;Response, MoyaError&gt;, target: TargetType) {
        NetWorksIndicatorScheduler.shared.popActivityIndicator()
    }
}

</code></pre></div><p>网络活动日志统计插件</p>
<pre><code>import Moya

/// 网络活动日志统计
public final class NetWorksLoggerPlugin: PluginType {
    
    public func willSend(_ request: RequestType, target: TargetType) {
        #if DEBUG
        print(request.request?.url ?? &quot;request error&quot;)
        print(request.request?.allHTTPHeaderFields ?? &quot;&quot;)
        #endif
    }
    
    public func didReceive(_ result: Result&lt;Response, MoyaError&gt;, target: TargetType) {
        #if DEBUG
        switch result {
        case .success(let response):
            let printString = response.request?.url?.absoluteString ?? &quot;无法找到请求路径&quot;
            print(&quot;success&quot; + printString)
        case .failure(let error):
            print(&quot;error: &quot; + error.errorDescription)
        }
        #endif
    }
}
</code></pre><h4 id="错误处理">错误处理</h4>
<p><code>MoyaError</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">MoyaError</span> {
    
    <span style="color:#6272a4">/// MoyaError错误描述</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorMoyaDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> MoyaError.imageMapping:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (图片数据解析).&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.jsonMapping:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (Json数据解析).&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.stringMapping:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (字符串数据解析).&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.objectMapping(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span>, <span style="color:#ff79c6">_</span>):
            <span style="color:#ff79c6">return</span> error.errorDescription
        <span style="color:#ff79c6">case</span> MoyaError.encodableMapping:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (Encodable Mapping).&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.statusCode(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">response</span>):
            <span style="color:#ff79c6">return</span> (<span style="color:#f1fa8c">&#34;请求失败,请重试! 错误码： &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;(</span><span style="color:#f1fa8c">\(</span>response.statusCode<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">)&#34;</span>)
        <span style="color:#ff79c6">case</span> MoyaError.requestMapping:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (Request Mapping)&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.parameterEncoding(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span>):
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (Parameter Encoding): </span><span style="color:#f1fa8c">\(</span>error.errorDescription<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>
        <span style="color:#ff79c6">case</span> MoyaError.underlying(<span style="color:#ff79c6">_</span>, <span style="color:#ff79c6">_</span>):
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;请求异常 (Underlying)&#34;</span>
        }
    }
}

</code></pre></div><p>自己服务器错误</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>

<span style="color:#6272a4">/// 自己服务器错误</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">APIError</span>: Swift.Error {
    
    <span style="color:#6272a4">/// 解析Json格式错误</span>
    <span style="color:#ff79c6">case</span> parseJsonError

    <span style="color:#6272a4">/// 解析服务器定义StatusCode格式错误</span>
    <span style="color:#ff79c6">case</span> parseStatusCodeTypeError
    
    <span style="color:#6272a4">/// 服务器自定义错误</span>
    <span style="color:#ff79c6">case</span> serverDefineError(code: <span style="color:#8be9fd;font-style:italic">String</span>, message: <span style="color:#8be9fd;font-style:italic">String</span>)
}


<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">APIError</span> {
    
    <span style="color:#6272a4">/// 自己服务器错误描述</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorAPIDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .parseJsonError:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;解析Json格式错误&#34;</span>
        <span style="color:#ff79c6">case</span> .parseStatusCodeTypeError:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;解析服务器定义StatusCode格式错误&#34;</span>
        <span style="color:#ff79c6">case</span> .serverDefineError(<span style="color:#ff79c6">_</span>, <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">message</span>): <span style="color:#6272a4">//返回服务器定义的错误信息</span>
            <span style="color:#ff79c6">return</span> message
        }
    }
}
</code></pre></div><p>错误描述扩展</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Swift</span>.Error {
    <span style="color:#6272a4">/// Swift.Error错误描述 兼容所有错误类型的描述</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">moyaError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? MoyaError {
            <span style="color:#ff79c6">return</span> moyaError.errorMoyaDescription
        } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">apiError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? APIError {
            <span style="color:#ff79c6">return</span> apiError.errorAPIDescription
        }<span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">rpError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? ResourceProviderError {
            <span style="color:#ff79c6">return</span> rpError.errorRPDescription
        } <span style="color:#ff79c6">else</span> {
            <span style="color:#ff79c6">return</span> localizedDescription
        }
    }
    
    <span style="color:#6272a4">/// 是否是 Moya被取消的网络请求</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">isMoyaCancledType</span>: <span style="color:#8be9fd;font-style:italic">Bool</span> {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">result</span>: <span style="color:#8be9fd;font-style:italic">Bool</span>
        
        <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">moyaError</span> = <span style="color:#ff79c6">self</span> <span style="color:#ff79c6">as</span>? MoyaError <span style="color:#ff79c6">else</span> {
            result = <span style="color:#ff79c6">false</span>
            <span style="color:#ff79c6">return</span> result
        }
        
        <span style="color:#ff79c6">switch</span> moyaError {
        <span style="color:#ff79c6">case</span> .underlying(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">err</span>, <span style="color:#ff79c6">_</span>):
            result = (err <span style="color:#ff79c6">as</span> NSError).code == <span style="color:#ff79c6">-</span><span style="color:#bd93f9">999</span>
        <span style="color:#ff79c6">default</span>:
            result = <span style="color:#ff79c6">false</span>
        }
        
        <span style="color:#ff79c6">return</span> result
    }
}

</code></pre></div><h4 id="发送请求">发送请求</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">UIKit</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">RxSwift</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">PromiseKit</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Moya</span>
<span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MoyaViewController</span>: BaseViewController {

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_provide</span> = APIProvider&lt;ServerApi&gt;()

    <span style="color:#ff79c6">override</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">viewDidLoad</span>() {
        <span style="color:#ff79c6">super</span>.viewDidLoad()
    }
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">MoyaViewController</span> {
    
    <span style="color:#ff79c6">override</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">touchesBegan</span>(<span style="color:#ff79c6">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?) {
        moyaRequest()
    }
    
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">moyaRequest</span>() {
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">requestPromis</span>: Promise&lt;ResponseData<span style="color:#ff79c6">&lt;</span>[Post]<span style="color:#ff79c6">&gt;&gt;</span> = _provide.request(targetType: .getPosts(id: <span style="color:#bd93f9">1</span>))
        
        
        requestPromis.ensure {
            <span style="color:#6272a4">//请求完成前</span>
            }.done { (result) <span style="color:#ff79c6">in</span>
                <span style="color:#6272a4">//请求完成</span>
                print(<span style="color:#f1fa8c">&#34;请求成功回调：&#34;</span>,result,result.message)
                 
            }.<span style="color:#ff79c6">catch</span> { (error) <span style="color:#ff79c6">in</span>
                <span style="color:#6272a4">//错误处理</span>
                print(<span style="color:#f1fa8c">&#34;请求失败回调：&#34;</span>,error)
        }
    }
}
</code></pre></div><h4 id="扩展资源文件加载">扩展，资源文件加载</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>
<span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">RxSwift</span>

<span style="color:#6272a4">/// ResourceProviderType 协议</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">protocol</span> <span style="color:#50fa7b">ResourceProviderType</span> {
    
    associatedtype ModelType: Codable
    
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fetchSync</span>(name: <span style="color:#8be9fd;font-style:italic">String</span>, type: <span style="color:#8be9fd;font-style:italic">String</span>) -&gt; Result&lt;ModelType, ResourceProviderError&gt;
    
    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fetchAsync</span>(name: <span style="color:#8be9fd;font-style:italic">String</span>, type: <span style="color:#8be9fd;font-style:italic">String</span>, callbackQueue: DispatchQueue?, completionHandler: @escaping (<span style="color:#ff79c6">_</span> result: Result&lt;ModelType, ResourceProviderError&gt;) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>)
}

<span style="color:#6272a4">/// 资源 Provider</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">struct</span> <span style="color:#50fa7b">ResourceProvider</span>&lt;ModelType: Codable&gt;: ResourceProviderType {
    
    <span style="color:#6272a4">/// 同步获取</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fetchSync</span>(name: <span style="color:#8be9fd;font-style:italic">String</span>, type: <span style="color:#8be9fd;font-style:italic">String</span>) -&gt; Result&lt;ModelType, ResourceProviderError&gt; {
        <span style="color:#ff79c6">do</span> {
            <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">resourcePath</span> = Bundle.main.path(forResource: name, ofType: type) <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">throw</span> ResourceProviderError.notFound }
            
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">decoder</span>: JSONDecoder = JSONDecoder()
            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">jsonData</span> = <span style="color:#ff79c6">try</span> Data(contentsOf: URL(fileURLWithPath: resourcePath))
            
            <span style="color:#ff79c6">guard</span> jsonData.count <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">else</span> {
                <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">resultObj</span> = <span style="color:#ff79c6">try</span> decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: jsonData)
                <span style="color:#ff79c6">return</span> .success(resultObj)
            }
            
            <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONObjectData</span> = <span style="color:#f1fa8c">&#34;{}&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: emptyJSONObjectData) {
                <span style="color:#ff79c6">return</span> .success(emptyDecodableValue)
            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONArrayData</span> = <span style="color:#f1fa8c">&#34;[{}]&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: emptyJSONArrayData) {
                <span style="color:#ff79c6">return</span> .success(emptyDecodableValue)
            } <span style="color:#ff79c6">else</span> {
                <span style="color:#ff79c6">throw</span> ResourceProviderError.empty
            }
            
        } <span style="color:#ff79c6">catch</span> {
            
            <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">errorT</span> = error <span style="color:#ff79c6">as</span>? ResourceProviderError {
                <span style="color:#ff79c6">return</span> .failure(errorT)
            } <span style="color:#ff79c6">else</span> {
                <span style="color:#ff79c6">return</span> .failure(ResourceProviderError.mapObjectFail(error: error))
            }
        }
    }
    
    <span style="color:#6272a4">/// 异步获取 默认在主线程返回数据</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fetchAsync</span>(name: <span style="color:#8be9fd;font-style:italic">String</span>, type: <span style="color:#8be9fd;font-style:italic">String</span>, callbackQueue: DispatchQueue?, completionHandler: @escaping (Result&lt;ModelType, ResourceProviderError&gt;) -&gt; <span style="color:#8be9fd;font-style:italic">Void</span>) {
        
        <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">callbackQueueT</span> = callbackQueue ?? DispatchQueue.main
        
        DispatchQueue.global().async {
            <span style="color:#ff79c6">do</span> {
                <span style="color:#ff79c6">guard</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">resourcePath</span> = Bundle.main.path(forResource: name, ofType: type) <span style="color:#ff79c6">else</span> { <span style="color:#ff79c6">throw</span> ResourceProviderError.notFound }
                
                <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">decoder</span>: JSONDecoder = JSONDecoder()
                <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">jsonData</span> = <span style="color:#ff79c6">try</span> Data(contentsOf: URL(fileURLWithPath: resourcePath))
                
                <span style="color:#ff79c6">guard</span> jsonData.count <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">else</span> {
                    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">resultObj</span> = <span style="color:#ff79c6">try</span> decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: jsonData)
                    callbackQueueT.async { completionHandler(.success(resultObj)) }
                    <span style="color:#ff79c6">return</span>
                }
                
                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONObjectData</span> = <span style="color:#f1fa8c">&#34;{}&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: emptyJSONObjectData) {
                    callbackQueueT.async { completionHandler(.success(emptyDecodableValue)) }
                } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyJSONArrayData</span> = <span style="color:#f1fa8c">&#34;[{}]&#34;</span>.data(using: .utf8), <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">emptyDecodableValue</span> = <span style="color:#ff79c6">try</span>? decoder.decode(ModelType.<span style="color:#ff79c6">self</span>, from: emptyJSONArrayData) {
                    callbackQueueT.async { completionHandler(.success(emptyDecodableValue)) }
                } <span style="color:#ff79c6">else</span> {
                    <span style="color:#ff79c6">throw</span> ResourceProviderError.empty
                }
                
                <span style="color:#ff79c6">return</span>
                
            } <span style="color:#ff79c6">catch</span> {
                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">errorT</span> = error <span style="color:#ff79c6">as</span>? ResourceProviderError {
                    callbackQueueT.async { completionHandler(.failure(errorT)) }
                } <span style="color:#ff79c6">else</span> {
                    callbackQueueT.async { completionHandler(.failure(.mapObjectFail(error: error))) }
                }
                <span style="color:#ff79c6">return</span>
            }
        }
    }
}

<span style="color:#6272a4">// </span><span style="color:#6272a4">MARK:</span><span style="color:#6272a4"> - Rx支持</span>
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">ResourceProvider</span>: ReactiveCompatible {}
<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">Reactive</span> <span style="color:#ff79c6">where</span> Base: ResourceProviderType {
    
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fetch</span>(name: <span style="color:#8be9fd;font-style:italic">String</span>, type: <span style="color:#8be9fd;font-style:italic">String</span>) -&gt; Single&lt;Base.ModelType&gt; {
        
        <span style="color:#ff79c6">return</span> Single.create { single <span style="color:#ff79c6">in</span>
            <span style="color:#ff79c6">self</span>.base.fetchAsync(name: name, type: type, callbackQueue: <span style="color:#ff79c6">nil</span>, completionHandler: { result <span style="color:#ff79c6">in</span>
                <span style="color:#ff79c6">switch</span> result {
                <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">let</span> .success(model):
                    single(.success(model))
                <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">let</span> .failure(error):
                    single(.error(error))
                }
            })
            <span style="color:#ff79c6">return</span> Disposables.create()
        }
    }
}

</code></pre></div><p>资源错误处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#8be9fd;font-style:italic">import</span> <span style="color:#50fa7b">Foundation</span>

<span style="color:#6272a4">/// 资源错误</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">enum</span> <span style="color:#50fa7b">ResourceProviderError</span>: Swift.Error {
    
    <span style="color:#6272a4">/// 找不到资源</span>
    <span style="color:#ff79c6">case</span> notFound
    
    <span style="color:#6272a4">/// 解析 Json Object失败</span>
    <span style="color:#ff79c6">case</span> mapObjectFail(error: Error)
    
    <span style="color:#6272a4">/// 资源为空</span>
    <span style="color:#ff79c6">case</span> empty
}

<span style="color:#8be9fd;font-style:italic">extension</span> <span style="color:#50fa7b">ResourceProviderError</span> {
    
    <span style="color:#6272a4">/// 资源错误描述</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">errorRPDescription</span>: <span style="color:#8be9fd;font-style:italic">String</span> {
        <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">self</span> {
        <span style="color:#ff79c6">case</span> .notFound:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;找不到该资源&#34;</span>
        <span style="color:#ff79c6">case</span> .empty:
            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;资源为空&#34;</span>
        <span style="color:#ff79c6">case</span> .mapObjectFail(<span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span>):
            <span style="color:#ff79c6">return</span> error.errorDescription
        }
    }
}
</code></pre></div>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/04/19/swiftURlAlamofireDetail/" data-toggle="tooltip" data-placement="top" title="Alamofire源码解析">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/04/20/swiftURlMoyaDetail/" data-toggle="tooltip" data-placement="top" title="Moya - 源码解析">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/go" title="go">
                            go
                        </a>
                        
                        
                        
                        <a href="/tags/ios" title="ios">
                            ios
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/swift" title="swift">
                            swift
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/web" title="web">
                            web
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Cheng Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:401932941@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/luckyliang">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Cheng Blog 2017
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
